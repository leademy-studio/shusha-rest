# Инструкция по настройке SSL-сертификатов в проекте

В данном проекте за обработку HTTPS-трафика и управление SSL-сертификатами отвечает обратный прокси-сервер **Traefik**. Архитектура поддерживает два основных подхода к настройке SSL:

1.  **Автоматический (через Let's Encrypt)**: Traefik самостоятельно запрашивает, получает, устанавливает и автоматически продлевает бесплатные сертификаты от Let's Encrypt. **Это рекомендуемый и используемый по умолчанию способ в данном проекте.**
2.  **Ручной**: Вы самостоятельно получаете файлы сертификата (`.crt`) и приватного ключа (`.key`) и подключаете их к Traefik через конфигурационные файлы. Этот способ используется реже, например, для сертификатов от других удостоверяющих центров или для тестовых сред.

---

## 1. Автоматическая настройка с помощью Let's Encrypt (Рекомендуемый способ)

Этот метод является предпочтительным, так как он полностью автоматизирует рутинные задачи по управлению жизненным циклом сертификатов.

### Принцип работы

1.  **Traefik** при запуске анализирует `labels` (метки) у Docker-контейнеров.
2.  Если у роутера контейнера (например, `nginx`) указана метка `traefik.http.routers.my-router.tls.certresolver=letsencrypt`, Traefik понимает, что для домена из правила `Host(...)` нужно получить сертификат.
3.  Traefik обращается к серверам Let's Encrypt, используя email и настройки из `traefik/traefik.yml`.
4.  Let's Encrypt проводит проверку владения доменом (в нашей конфигурации это `httpChallenge`): он делает запрос на ваш домен по порту 80. Traefik перехватывает этот запрос и дает правильный ответ, подтверждая, что вы контролируете домен.
5.  После успешной проверки Let's Encrypt выпускает сертификат.
6.  Traefik сохраняет полученный сертификат в файл `acme.json` (на хосте `/etc/traefik/shusha/acme.json`) и сразу же начинает его использовать для HTTPS-соединений.
7.  Traefik будет автоматически отслеживать срок действия сертификата и заблаговременно его продлевать.

### Ключевые файлы и параметры

*   **`traefik/traefik.yml`**: Статическая конфигурация Traefik.
    *   В секции `certificatesResolvers` определяется "резолвер" сертификатов с именем `letsencrypt`.
    *   `email: info@leademy.studio`: Ваш email для уведомлений от Let's Encrypt (например, о скором истечении срока действия сертификата, если автоматическое продление не удастся). **Крайне важно указать действующий email.**
    *   `storage: /etc/traefik/acme.json`: Путь *внутри контейнера* к файлу, где будут храниться все полученные сертификаты.
    *   `httpChallenge`: Указывает, что для проверки домена будет использоваться HTTP-запрос через точку входа `web` (порт 80).

*   **`docker-compose.yml`**: Оркестрация сервисов.
    *   В сервисе `traefik` том (volume) `/etc/traefik/shusha/acme.json:/etc/traefik/acme.json` монтирует файл `acme.json` в контейнер, обеспечивая персистентность сертификатов и независимость от репозитория.
    *   В сервисе `nginx` (или любом другом, который вы хотите открыть миру по HTTPS) ключевую роль играют `labels`:
        ```yaml
        labels:
          - "traefik.enable=true"
          # Правило, указывающее, для какого домена этот роутер
          - "traefik.http.routers.shusha-rest.rule=Host(`shusha72.ru`,`www.shusha72.ru`)"
          # Включаем TLS для этого роутера
          - "traefik.http.routers.shusha-rest.tls=true"
          # Указываем Traefik использовать наш резолвер 'letsencrypt'
          # (В этом проекте добавляется скриптом scripts/renew_on_last_day.sh в последний день валидности)
          - "traefik.http.routers.shusha-rest.tls.certresolver=letsencrypt"
        ```

*   **`/etc/traefik/shusha/acme.json`**: Файл для хранения сертификатов на хосте. При первом запуске он должен быть пустым, но существующим.

### Пошаговая инструкция по настройке

1.  **Настройте DNS**: Убедитесь, что A-запись (и AAAA, если используете IPv6) для вашего домена (`shusha72.ru` и `www.shusha72.ru`) указывает на публичный IP-адрес сервера, где запущен Docker. Это необходимо для прохождения `httpChallenge`.

2.  **Укажите Email**: Откройте `traefik/traefik.yml` и в секции `certificatesResolvers.letsencrypt.acme` укажите ваш реальный email-адрес.

    ```yaml
    certificatesResolvers:
      letsencrypt:
        acme:
          email: your-email@example.com # <-- ЗАМЕНИТЕ НА ВАШ EMAIL
          storage: /etc/traefik/acme.json
          httpChallenge:
            entryPoint: web
    ```

3.  **Проверьте метки в Docker Compose**: Убедитесь, что в `docker-compose.yml` у сервиса `app` (или другого целевого сервиса) в `labels` указаны корректные домены в правилах `Host(...)`. Метка `traefik.http.routers.НАЗВАНИЕ_РОУТЕРА.tls.certresolver=letsencrypt` в этом проекте управляется скриптом `scripts/renew_on_last_day.sh` и добавляется только в последний день валидности сертификата. Проект уже настроен для доменов `shusha72.ru` и `www.shusha72.ru`.

4.  **Создайте и настройте `acme.json`**: Если файла `/etc/traefik/shusha/acme.json` не существует, создайте его с пустым содержимым:

    ```bash
    touch /etc/traefik/shusha/acme.json
    ```

    **ВАЖНО**: Установите для этого файла правильные права доступа, чтобы только владелец мог его читать и изменять. Traefik очень чувствителен к этому из соображений безопасности.

    ```bash
    chmod 600 /etc/traefik/shusha/acme.json
    ```

5.  **Запустите сервисы**: Запустите всю связку с помощью Docker Compose.

    ```bash
    docker compose up -d
    ```

6.  **Проверьте логи**: Отслеживайте логи контейнера Traefik, чтобы увидеть процесс получения сертификата.

    ```bash
    docker compose logs -f traefik
    ```

    При успешном получении вы увидите сообщения, похожие на:
    `time="..." level=debug msg="legolog: [INFO] [shusha72.ru] acme: Server responded with a certificate."`
    `time="..." level=debug msg="Certificates obtained for domains..."`

    После этого файл `acme.json` заполнится данными о сертификатах.

### Возможные проблемы

*   **Ошибка "rate limit"**: Let's Encrypt имеет ограничения на количество запросов. Для отладки можно временно использовать тестовый сервер Let's Encrypt, добавив `caServer: "https://acme-staging-v02.api.letsencrypt.org/directory"` в секцию `acme` файла `traefik.yml`.
*   **Ошибка "Timeout during challenge"**: Чаще всего означает, что ваш сервер недоступен извне по порту 80, либо DNS-запись еще не обновилась. Проверьте настройки файрвола и DNS.

---

## 2. Ручная настройка SSL-сертификатов

Этот способ подходит, если у вас уже есть файлы сертификата и ключа, и вы не хотите использовать Let's Encrypt.

### Принцип работы

1.  Вы размещаете файлы `.crt` (сертификат) и `.key` (приватный ключ) в директорию, доступную для Traefik.
2.  В специальном файле динамической конфигурации (в нашем случае `/etc/traefik/shusha/dynamic/certs.yml`) вы указываете Traefik пути к этим файлам.
3.  Traefik при запуске читает этот файл и загружает сертификаты в память.
4.  Когда приходит запрос на домен, покрываемый этим сертификатом, Traefik автоматически его использует.

### Ключевые файлы и параметры

*   **`/etc/traefik/shusha/certs/`**: Директория для хранения ваших файлов сертификатов на хосте (если используется ручной режим).
*   **`/etc/traefik/shusha/dynamic/certs.yml`**: Файл, описывающий, какие сертификаты нужно загрузить. В текущем проекте он закомментирован.
    ```yaml
    # tls:
    #   certificates:
    #     - certFile: /etc/traefik/certs/shusha72.ru.crt
    #       keyFile: /etc/traefik/certs/shusha72.ru.key
    ```
    Пути `certFile` и `keyFile` указываются относительно файловой системы *внутри контейнера* Traefik.

### Пошаговая инструкция по настройке

1.  **Получите файлы сертификата**: У вас должны быть два файла:
    *   Файл сертификата (например, `mydomain.crt`). Он должен включать в себя как сертификат для домена, так и всю цепочку промежуточных сертификатов (fullchain).
    *   Файл приватного ключа (например, `mydomain.key`).

2.  **Разместите файлы**: Положите оба файла в директорию `/etc/traefik/shusha/certs/`.

3.  **Настройте `certs.yml`**: Откройте файл `/etc/traefik/shusha/dynamic/certs.yml`, раскомментируйте его и укажите пути к вашим файлам.

    ```yaml
    tls:
      certificates:
        - certFile: /etc/traefik/certs/mydomain.crt
          keyFile: /etc/traefik/certs/mydomain.key
    ```

4.  **Измените метки в Docker Compose**: В файле `docker-compose.yml` для сервиса `nginx` найдите метку `tls.certresolver` и **удалите или закомментируйте** ее. Метка `traefik.http.routers.НАЗВАНИЕ_РОУТЕРА.tls=true` должна остаться.

    ```yaml
    # Было:
    # - "traefik.http.routers.shusha-rest.tls.certresolver=letsencrypt"
    
    # Стало (этой строки просто не должно быть):
    ```

5.  **Перезапустите Traefik**:

    ```bash
    docker compose up -d --force-recreate traefik
    ```

Теперь Traefik будет использовать сертификат, указанный вами вручную.

### Важные аспекты

*   **Продление**: При ручном способе вы несете полную ответственность за своевременное продление и замену файлов сертификатов. Traefik не будет делать это за вас.
*   **Цепочка сертификатов**: Файл `.crt` должен быть полным (fullchain), иначе браузеры могут выдавать ошибку о недоверенном сертификате.

---

## Заключение

Для публичных веб-сайтов, как в данном проекте, **автоматический способ с Let's Encrypt является стандартом**. Он избавляет от головной боли с продлением сертификатов и легко настраивается. Ручной способ остается вариантом для специфических случаев, таких как корпоративные сертификаты или среды разработки.
